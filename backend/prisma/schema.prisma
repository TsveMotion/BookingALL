generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER       // Business owner
  MANAGER     // Location manager
  STAFF       // Staff member
  ADMIN       // Platform admin
}

enum BusinessCategory {
  BEAUTICIAN
  HAIRDRESSER
  BARBER
  NAIL_TECH
  MASSAGE
  SPA
  OTHER
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Core User Model - Multi-tenant ready
model User {
  id                String            @id @default(cuid())
  email             String            @unique
  passwordHash      String
  name              String?
  phone             String?
  emailVerified     Boolean           @default(false)
  role              UserRole          @default(OWNER)
  
  // Business relationship (null if platform admin)
  businessId        String?
  business          Business?         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Owned business (if role is OWNER)
  ownedBusiness     Business?         @relation("BusinessOwner")
  
  // Avatar
  avatar            String?
  
  // Two-Factor Authentication (Pro only)
  twoFactorEnabled  Boolean           @default(false)
  twoFactorSecret   String?
  
  // Activity tracking
  lastLoginAt       DateTime?
  lastActiveAt      DateTime?
  loginActivity     LoginActivity[]
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  sessions          Session[]
  verificationTokens VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  bookingsCreated   Booking[]         @relation("BookingCreatedBy")
  servicesCreated   Service[]
  staffProfile      Staff?
  notifications     Notification[]
  
  @@index([email])
  @@index([businessId])
  @@index([role])
}

// Business Model - Each tenant
model Business {
  id                String            @id @default(cuid())
  
  // Business Info
  name              String
  slug              String            @unique
  subdomain         String?           @unique // For marketing funnels: [businessname].glambooking.co.uk
  category          BusinessCategory
  description       String?           @db.Text
  logo              String?
  
  // Contact
  email             String?
  phone             String?
  website           String?
  
  // Address
  address           String?
  city              String?
  postcode          String?
  country           String            @default("UK")
  
  // Subscription
  plan              SubscriptionPlan  @default(FREE)
  subscriptionStatus String           @default("active")
  stripeCustomerId  String?           @unique
  stripeSubscriptionId String?        @unique
  
  // Owner
  ownerId           String            @unique
  owner             User              @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Settings
  settings          Json?             // Business-specific settings
  branding          Json?             // Colors, fonts, etc.
  
  // Status
  active            Boolean           @default(true)
  onboardingComplete Boolean          @default(false)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  users             User[]
  locations         Location[]
  staff             Staff[]
  staffInvites      StaffInvite[]
  services          Service[]
  clients           Client[]
  bookings          Booking[]
  bookingPage       BookingPageSettings?
  businessSettings  BusinessSettings?
  notifications     Notification[]
  serviceAddons     ServiceAddon[]
  aftercareTemplates AftercareTemplate[]
  waiverTemplates   WaiverTemplate[]
  campaigns         Campaign[]
  wordpressIntegration WordPressIntegration?
  
  @@index([slug])
  @@index([category])
  @@index([ownerId])
  @@index([plan])
}

// Location Model - Multiple locations per business
model Location {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Location Info
  name              String
  description       String?           @db.Text
  address           String?
  city              String?
  postcode          String?
  country           String            @default("United Kingdom")
  phone             String?
  email             String?
  
  // Opening Hours - Structured JSON
  // {"monday": {"open": "09:00", "close": "17:00", "closed": false}, ...}
  openingHours      Json?             
  
  // Additional Details
  parkingInfo       String?           @db.Text
  accessibilityInfo String?           @db.Text
  
  // Social & Online
  socialLinks       Json?             // {"instagram": "...", "facebook": "...", "twitter": "..."}
  googleMapsUrl     String?
  websiteUrl        String?
  
  // Map Coordinates
  latitude          Float?
  longitude         Float?
  
  // Settings
  isPrimary         Boolean           @default(false)
  active            Boolean           @default(true)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  services          ServiceLocation[]
  bookings          Booking[]
  
  @@index([businessId])
  @@index([active])
  @@index([isPrimary])
}

// Staff Model - Team members per business
model Staff {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Link to User account (if they've accepted invite)
  userId            String?           @unique
  user              User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Staff Info
  name              String
  email             String
  phone             String?
  role              String?           // "Stylist", "Manager", "Receptionist", etc.
  avatar            String?
  bio               String?           @db.Text
  skills            String[]          @default([])
  
  // Location assignments (can be assigned to multiple locations)
  assignedLocationIds String[]        @default([])
  
  // Permissions - Full access control
  permissions       Json              @default("{\"canManageBookings\":false,\"canViewAllBookings\":false,\"canManageClients\":false,\"canViewAllClients\":false,\"canManageServices\":false,\"canManageLocations\":false,\"canManageTeam\":false,\"canViewAnalytics\":false,\"canManageSettings\":false,\"canViewBusinessBookings\":false}")
  
  // Status
  status            String            @default("pending") // "pending", "active", "inactive"
  active            Boolean           @default(true)
  inviteAccepted    Boolean           @default(false)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
  @@index([userId])
  @@index([email])
  @@index([active])
  @@unique([businessId, email])
}

// Staff Invite Model - For sending invitations to new staff
model StaffInvite {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Invite details
  email             String
  name              String
  role              String?
  assignedLocationIds String[]        @default([])
  permissions       Json              @default("{\"canManageBookings\":false,\"canViewAllBookings\":false,\"canManageClients\":false,\"canViewAllClients\":false,\"canManageServices\":false,\"canManageLocations\":false,\"canManageTeam\":false,\"canViewAnalytics\":false,\"canManageSettings\":false,\"canViewBusinessBookings\":false}")
  
  // Token for secure invite link
  token             String            @unique
  expiresAt         DateTime
  
  // Status
  used              Boolean           @default(false)
  usedAt            DateTime?
  
  // Created by
  createdById       String
  
  // Metadata
  createdAt         DateTime          @default(now())
  
  @@index([businessId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

// Service Model
model Service {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Service Info
  name              String
  description       String?           @db.Text
  duration          Int               // Duration in minutes
  price             Float             // Price in pounds
  
  // Categorization
  category          String?
  
  // Staff assignment
  staffIds          String[]          @default([])
  
  // Media
  gallery           String[]          @default([])
  
  // Requirements & Instructions
  waiverRequired          Boolean           @default(false)
  aftercareInstructions   String?           @db.Text
  preparationInstructions String?           @db.Text
  
  // Created by
  createdById       String
  createdBy         User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  // Status
  active            Boolean           @default(true)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  locations         ServiceLocation[]
  bookings          Booking[]
  addons            ServiceAddon[]
  aftercareTemplate AftercareTemplate?
  waiverTemplate    WaiverTemplate?
  
  @@index([businessId])
  @@index([active])
  @@index([createdById])
}

// Junction table for Service-Location relationship
model ServiceLocation {
  id                String            @id @default(cuid())
  serviceId         String
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  locationId        String
  location          Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  active            Boolean           @default(true)
  createdAt         DateTime          @default(now())
  
  @@unique([serviceId, locationId])
  @@index([serviceId])
  @@index([locationId])
}

// Client Model
model Client {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Client Info
  name              String
  email             String
  phone             String?
  birthday          DateTime?
  address           String?           @db.Text
  
  // Custom Fields
  occupation        String?
  referralSource    String?           // How they found us
  emergencyContact  String?
  emergencyPhone    String?
  
  // Medical & Preferences
  allergies         String?           @db.Text
  medicalConditions String?           @db.Text
  skinType          String?           // "dry", "oily", "combination", "sensitive"
  preferences       String?           @db.Text // Product preferences, etc.
  
  // Notes & Tags
  notes             String?           @db.Text
  internalNotes     String?           @db.Text // Private staff notes
  tags              String[]          @default([])
  
  // Marketing
  marketingConsent  Boolean           @default(false)
  smsConsent        Boolean           @default(false)
  emailConsent      Boolean           @default(false)
  
  // Status
  vipStatus         Boolean           @default(false)
  status            String            @default("active") // "active", "inactive", "blocked"
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  bookings          Booking[]
  campaignRecipients CampaignRecipient[]
  
  @@index([businessId])
  @@index([email])
  @@unique([businessId, email])
}

// Booking Model
model Booking {
  id                String            @id @default(cuid())
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Client
  clientId          String
  client            Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Service
  serviceId         String
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Location
  locationId        String?
  location          Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  
  // Staff (optional)
  staffId           String?
  
  // Time
  startTime         DateTime
  endTime           DateTime
  
  // Status
  status            BookingStatus     @default(PENDING)
  
  // Payment
  totalAmount       Float
  paymentStatus     PaymentStatus     @default(PENDING)
  paymentMethod     String?           // "card", "cash", "bank_transfer"
  stripePaymentId   String?
  
  // Notes
  notes             String?           @db.Text
  
  // Add-ons
  addons            BookingAddon[]
  
  // Aftercare tracking
  aftercareSent     Boolean           @default(false)
  aftercareSentAt   DateTime?
  
  // Waiver tracking
  waiverRequired    Boolean           @default(false)
  waiverSigned      Boolean           @default(false)
  waiverSignedAt    DateTime?
  waiverUrl         String?
  
  // Created by (staff member who created it)
  createdById       String
  createdBy         User              @relation("BookingCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([startTime])
  @@index([status])
  @@index([createdById])
}

// Authentication Models
model Session {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Token
  token             String            @unique
  refreshToken      String            @unique
  
  // Expiry
  expiresAt         DateTime
  refreshExpiresAt  DateTime
  
  // Metadata
  userAgent         String?
  ipAddress         String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([userId])
  @@index([token])
  @@index([refreshToken])
  @@index([expiresAt])
}

model VerificationToken {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token             String            @unique
  expiresAt         DateTime
  
  createdAt         DateTime          @default(now())
  
  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token             String            @unique
  expiresAt         DateTime
  used              Boolean           @default(false)
  
  createdAt         DateTime          @default(now())
  
  @@index([userId])
  @@index([token])
}

// Booking Page Settings - Customizable public booking page
model BookingPageSettings {
  id                String            @id @default(cuid())
  businessId        String            @unique
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Page Status
  enabled           Boolean           @default(true)
  
  // Branding
  primaryColor      String            @default("#9333ea") // Purple
  logo              String?
  coverImage        String?
  
  // Content
  heroTitle         String?
  heroDescription   String?           @db.Text
  welcomeMessage    String?           @db.Text
  thankYouMessage   String?           @db.Text
  
  // SEO
  metaTitle         String?
  metaDescription   String?           @db.Text
  
  // Business Hours
  openingHours      Json?             // {"monday": {"open": "09:00", "close": "17:00", "closed": false}}
  
  // Booking Settings
  requireDeposit    Boolean           @default(false)
  depositPercent    Int               @default(20)      // Percentage for deposit
  allowOnlinePayment Boolean          @default(true)
  requireApproval   Boolean           @default(false)    // Manual approval for bookings
  
  // Cancellation
  cancellationPolicy String?          @db.Text
  cancellationHours  Int              @default(24)      // Hours before appointment
  
  // Service Visibility
  visibleServiceIds  String[]         @default([])      // Empty = all visible
  
  // Gallery
  galleryImages     String[]          @default([])
  
  // Social Links
  socialLinks       Json?             // {"instagram": "...", "facebook": "..."}
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
  @@index([enabled])
}

// Business Settings Model - Extended settings for Pro features
model BusinessSettings {
  id                String            @id @default(cuid())
  businessId        String            @unique
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Branding (Pro only)
  branding          Json?             // {"primaryColor": "#...", "accentColor": "#...", "font": "...", "logo": "...", "coverImage": "..."}
  
  // SEO Settings (Pro only)
  seo               Json?             // {"metaTitle": "...", "metaDescription": "...", "keywords": []}
  
  // Notifications
  notifications     Json?             // {"emailNotifications": true, "bookingReminders": true, ...}
  
  // Custom Domain (Pro only)
  customDomain      String?
  
  // Social Links
  socialLinks       Json?             // {"instagram": "...", "facebook": "...", "twitter": "...", "linkedin": "..."}
  
  // Google Maps
  googlePlaceId     String?
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
}

// Login Activity Model - Track user login history (Pro only)
model LoginActivity {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Login details
  ipAddress         String?
  userAgent         String?
  device            String?
  location          String?           // City, Country
  
  // Status
  success           Boolean           @default(true)
  failureReason     String?
  
  // Metadata
  createdAt         DateTime          @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// Notification Model
model Notification {
  id                String            @id @default(cuid())
  
  // User & Business
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Notification details
  type              String            // booking_created, client_created, payment_successful, etc.
  message           String
  meta              Json?             // Additional metadata
  read              Boolean           @default(false)
  
  // Metadata
  createdAt         DateTime          @default(now())
  
  @@index([userId])
  @@index([businessId])
  @@index([createdAt])
  @@index([read])
}

// Service Add-on Model
model ServiceAddon {
  id                String            @id @default(cuid())
  
  // Service relationship
  serviceId         String
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Business
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Add-on details
  name              String
  description       String?           @db.Text
  priceAdjustment   Float             @default(0) // Can be positive or negative
  durationAdjustment Int              @default(0) // In minutes, can be positive or negative
  required          Boolean           @default(false)
  
  // Status
  active            Boolean           @default(true)
  
  // Usage tracking
  bookingAddons     BookingAddon[]
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([serviceId])
  @@index([businessId])
  @@index([active])
}

// Booking Add-on (junction table)
model BookingAddon {
  id                String            @id @default(cuid())
  
  // Booking
  bookingId         String
  booking           Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  // Add-on
  addonId           String
  addon             ServiceAddon      @relation(fields: [addonId], references: [id], onDelete: Cascade)
  
  // Pricing at time of booking (frozen)
  priceAdjustment   Float
  durationAdjustment Int
  
  // Metadata
  createdAt         DateTime          @default(now())
  
  @@index([bookingId])
  @@index([addonId])
}

// Aftercare Template Model
model AftercareTemplate {
  id                String            @id @default(cuid())
  
  // Service relationship (one template per service)
  serviceId         String            @unique
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Business
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Template details
  title             String
  content           String            @db.Text // HTML content
  
  // Delivery settings
  sendMethod        String            @default("email") // "email", "sms", "both"
  sendTrigger       String            @default("immediate") // "immediate", "delayed"
  sendDelayHours    Int               @default(0) // Hours after appointment
  
  // Status
  active            Boolean           @default(true)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
  @@index([serviceId])
  @@index([active])
}

// Waiver Template Model
model WaiverTemplate {
  id                String            @id @default(cuid())
  
  // Service relationship (one waiver per service)
  serviceId         String            @unique
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Business
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Waiver details
  title             String
  content           String            @db.Text // HTML content
  
  // Settings
  requireSignature  Boolean           @default(true)
  requireBefore     Boolean           @default(true) // Require before or after appointment
  autoSend          Boolean           @default(true) // Auto-send to client
  
  // Status
  active            Boolean           @default(true)
  
  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([businessId])
  @@index([serviceId])
  @@index([active])
}

// Campaign Model - Marketing Funnel
model Campaign {
  id                String              @id @default(cuid())
  
  // Business relationship
  businessId        String
  business          Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Campaign details
  name              String
  type              String              // "email", "sms", "followup", "promotion", "reactivation"
  subject           String?             // For emails
  message           String              @db.Text
  
  // Targeting
  targetAudience    String              // "all", "new", "returning", "inactive", "highvalue"
  
  // Schedule
  scheduledAt       DateTime?
  sentAt            DateTime?
  
  // Status
  status            String              @default("draft") // "draft", "scheduled", "sending", "sent", "failed"
  active            Boolean             @default(true)
  
  // Stats
  recipientCount    Int                 @default(0)
  sentCount         Int                 @default(0)
  deliveredCount    Int                 @default(0)
  openedCount       Int                 @default(0)
  clickedCount      Int                 @default(0)
  
  // Recipients
  recipients        CampaignRecipient[]
  
  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdBy         String?
  
  @@index([businessId])
  @@index([status])
  @@index([type])
  @@index([scheduledAt])
}

// Campaign Recipient Model
model CampaignRecipient {
  id                String              @id @default(cuid())
  
  // Campaign relationship
  campaignId        String
  campaign          Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Client relationship
  clientId          String
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Delivery status
  status            String              @default("pending") // "pending", "sent", "delivered", "failed", "bounced"
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  
  // Error tracking
  errorMessage      String?
  
  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([campaignId])
  @@index([clientId])
  @@index([status])
  @@unique([campaignId, clientId])
}

// WordPress Integration Model
model WordPressIntegration {
  id            String    @id @default(cuid())
  
  // Business relationship
  businessId    String    @unique
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // API Keys
  publicKey     String    @unique
  secretKey     String    @unique
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastUsedAt    DateTime?
  
  @@index([businessId])
  @@index([publicKey])
}
